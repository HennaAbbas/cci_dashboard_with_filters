<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CircleCI Data Dashboard</title>
  <!-- Include Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <!-- React and ReactDOM -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <!-- Babel for JSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.4/babel.min.js"></script>
  <!-- Lodash for data manipulation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
</head>
<body class="bg-gray-50">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-6">CircleCI Build Data Dashboard</h1>
    <div id="app"></div>
  </div>
  
  <!-- Your React component (written in JSX, will be transformed by Babel) -->
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // Main Dashboard Component
    const CircleCIDataDashboard = () => {
      const [data, setData] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [filters, setFilters] = useState({});
      const [activeFilters, setActiveFilters] = useState({});
      const [currentPage, setCurrentPage] = useState(1);
      const [rowsPerPage, setRowsPerPage] = useState(10);
      const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });
      const [columnOptions, setColumnOptions] = useState({});
      const [visibleColumns, setVisibleColumns] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [stats, setStats] = useState({});
      const [dataLoaded, setDataLoaded] = useState(false);
      const [dateRange, setDateRange] = useState({ startDate: '', endDate: '' });
      const [activeDateRange, setActiveDateRange] = useState({ startDate: '', endDate: '' });

      // Calculate statistics from the data
      const calculateStats = (data) => {
        const stats = {
          totalJobs: data.length,
          successfulJobs: data.filter(job => job.JOB_BUILD_STATUS === 'success').length,
          failedJobs: data.filter(job => job.JOB_BUILD_STATUS === 'failed').length,
          totalCredits: _.sumBy(data, 'TOTAL_CREDITS'),
          averageJobRuntime: _.meanBy(
            data.filter(job => job.JOB_RUN_SECONDS && job.JOB_RUN_SECONDS !== null), 
            'JOB_RUN_SECONDS'
          )
        };
        
        setStats(stats);
      };

      // Handle file upload
      const handleFileUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        setLoading(true);
        setError(null);
        
        const reader = new FileReader();
        reader.onload = (e) => {
          const csvText = e.target.result;
          
          Papa.parse(csvText, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: (results) => {
              console.log("File parsed successfully. Rows:", results.data.length);
              
              if (results.data.length === 0 || !results.meta.fields || results.meta.fields.length === 0) {
                setError("CSV parsing produced no valid data or headers");
                setLoading(false);
                return;
              }
              
              // Clean up data - replace "\\N" with null for better display
              const cleanData = results.data.map(row => {
                const cleanRow = {};
                results.meta.fields.forEach(field => {
                  cleanRow[field] = row[field] === "\\\\N" ? null : row[field];
                });
                return cleanRow;
              });
              
              setData(cleanData);
              
              // Set visible columns (first 10 columns by default)
              setVisibleColumns(results.meta.fields.slice(0, 10));
              
              // Generate filter options for each column
              const options = {};
              results.meta.fields.forEach(field => {
                // Get unique values for this column
                const uniqueValues = [...new Set(cleanData.map(item => item[field]))].filter(x => x !== null);
                options[field] = uniqueValues.sort();
              });
              setColumnOptions(options);
              
              // Calculate basic stats
              calculateStats(cleanData);
              
              setLoading(false);
              setDataLoaded(true);
            },
            error: (error) => {
              console.error("CSV parsing error:", error);
              setError(`Error parsing CSV: ${error.message}`);
              setLoading(false);
            }
          });
        };
        
        reader.onerror = () => {
          setError("Error reading file");
          setLoading(false);
        };
        
        reader.readAsText(file);
      };

      // Filter data based on active filters and date range
      const filteredData = useMemo(() => {
        if (Object.keys(activeFilters).length === 0 && !searchTerm && !activeDateRange.startDate && !activeDateRange.endDate) {
          return data;
        }

        return data.filter(item => {
          // Check if the item matches all active filters
          const matchesFilters = Object.entries(activeFilters).every(([field, value]) => {
            if (!value || value.length === 0) return true;
            return value.includes(item[field]);
          });
          
          // Check global search term
          const matchesSearch = !searchTerm || Object.values(item).some(val => {
            if (val === null) return false;
            return String(val).toLowerCase().includes(searchTerm.toLowerCase());
          });
          
          // Check date range for JOB_RUN_STARTED_AT
          let matchesDateRange = true;
          if (activeDateRange.startDate || activeDateRange.endDate) {
            const jobStartDate = item.JOB_RUN_STARTED_AT;
            
            if (!jobStartDate) {
              matchesDateRange = false;
            } else {
              const jobDate = new Date(jobStartDate);
              
              if (activeDateRange.startDate && activeDateRange.endDate) {
                const startDate = new Date(activeDateRange.startDate);
                const endDate = new Date(activeDateRange.endDate);
                // Set end date to end of day
                endDate.setHours(23, 59, 59, 999);
                
                matchesDateRange = jobDate >= startDate && jobDate <= endDate;
              } else if (activeDateRange.startDate) {
                const startDate = new Date(activeDateRange.startDate);
                matchesDateRange = jobDate >= startDate;
              } else if (activeDateRange.endDate) {
                const endDate = new Date(activeDateRange.endDate);
                // Set end date to end of day
                endDate.setHours(23, 59, 59, 999);
                
                matchesDateRange = jobDate <= endDate;
              }
            }
          }
          
          return matchesFilters && matchesSearch && matchesDateRange;
        });
      }, [data, activeFilters, searchTerm, activeDateRange]);

      // Sort data
      const sortedData = useMemo(() => {
        if (!sortConfig.key) return filteredData;
        
        return [...filteredData].sort((a, b) => {
          const aValue = a[sortConfig.key];
          const bValue = b[sortConfig.key];
          
          // Handle null values in sorting
          if (aValue === null && bValue === null) return 0;
          if (aValue === null) return sortConfig.direction === 'asc' ? 1 : -1;
          if (bValue === null) return sortConfig.direction === 'asc' ? -1 : 1;
          
          // Compare based on data type
          if (typeof aValue === 'number' && typeof bValue === 'number') {
            return sortConfig.direction === 'asc' ? aValue - bValue : bValue - aValue;
          }
          
          // Date comparison for date fields
          if (sortConfig.key.includes('_AT') || sortConfig.key.includes('DATE')) {
            try {
              const aDate = new Date(aValue);
              const bDate = new Date(bValue);
              if (!isNaN(aDate) && !isNaN(bDate)) {
                return sortConfig.direction === 'asc' ? aDate - bDate : bDate - aDate;
              }
            } catch (e) {
              // If date parsing fails, fall back to string comparison
            }
          }
          
          // String comparison
          const aString = String(aValue).toLowerCase();
          const bString = String(bValue).toLowerCase();
          
          if (sortConfig.direction === 'asc') {
            return aString.localeCompare(bString);
          } else {
            return bString.localeCompare(aString);
          }
        });
      }, [filteredData, sortConfig]);

      // Pagination
      const paginatedData = useMemo(() => {
        const startIndex = (currentPage - 1) * rowsPerPage;
        return sortedData.slice(startIndex, startIndex + rowsPerPage);
      }, [sortedData, currentPage, rowsPerPage]);

      // Handle sorting
      const requestSort = (key) => {
        let direction = 'asc';
        if (sortConfig.key === key && sortConfig.direction === 'asc') {
          direction = 'desc';
        }
        setSortConfig({ key, direction });
      };

      // Handle filter changes
      const handleFilterChange = (field, value) => {
        setFilters({
          ...filters,
          [field]: value
        });
      };

      // Apply filters
      const applyFilters = () => {
        setActiveFilters(filters);
        setActiveDateRange(dateRange);
        setCurrentPage(1); // Reset to first page when filters change
      };

      // Reset filters
      const resetFilters = () => {
        setFilters({});
        setActiveFilters({});
        setDateRange({ startDate: '', endDate: '' });
        setActiveDateRange({ startDate: '', endDate: '' });
        setSearchTerm('');
        setCurrentPage(1);
      };

      // Toggle column visibility
      const toggleColumnVisibility = (column) => {
        if (visibleColumns.includes(column)) {
          setVisibleColumns(visibleColumns.filter(col => col !== column));
        } else {
          setVisibleColumns([...visibleColumns, column]);
        }
      };

      // Calculate total pages
      const totalPages = Math.ceil(sortedData.length / rowsPerPage);

      // Format value for display
      const formatValue = (value, column) => {
        if (value === null || value === undefined) return "—";
        
        // Format dates
        if (column.includes('DATE') || column.includes('_AT')) {
          if (typeof value === 'string' && value.includes('-')) {
            return value;
          }
        }
        
        // Format numbers
        if (column.includes('CREDITS') && typeof value === 'number') {
          return value.toFixed(2);
        }
        
        return String(value);
      };

      // Get min and max dates for JOB_RUN_STARTED_AT
      const getDateBoundaries = () => {
        if (data.length === 0) return { min: '', max: '' };
        
        const dateValues = data
          .map(item => item.JOB_RUN_STARTED_AT)
          .filter(date => date !== null && date !== undefined);
        
        if (dateValues.length === 0) return { min: '', max: '' };
        
        const dateObjects = dateValues.map(d => new Date(d));
        const minDate = new Date(Math.min(...dateObjects));
        const maxDate = new Date(Math.max(...dateObjects));
        
        // Format as YYYY-MM-DD for date inputs
        const formatDate = (date) => {
          return date.toISOString().split('T')[0];
        };
        
        return {
          min: formatDate(minDate),
          max: formatDate(maxDate)
        };
      };
      
      const dateBoundaries = useMemo(getDateBoundaries, [data]);

      // Show loading state
      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="text-center">
              <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
              <p className="mt-4 text-lg">Loading data...</p>
            </div>
          </div>
        );
      }

      // Show file upload prompt if data not loaded
      if (!dataLoaded) {
        return (
          <div className="flex flex-col items-center justify-center space-y-6 p-8 border-2 border-dashed border-gray-300 rounded-lg bg-white">
            <div className="text-center">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              <h2 className="mt-2 text-xl font-semibold text-gray-900">Upload your CircleCI data</h2>
              <p className="mt-1 text-sm text-gray-500">Upload a CSV file to visualize and analyze your data</p>
            </div>
            
            <input
              type="file"
              accept=".csv"
              onChange={handleFileUpload}
              className="block w-full max-w-xs text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            />
            
            {error && (
              <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-4 w-full max-w-lg">
                <strong className="font-bold">Error!</strong>
                <span className="block sm:inline"> {error}</span>
              </div>
            )}
          </div>
        );
      }

      return (
        <div className="flex flex-col space-y-6">
          {/* File upload at the top */}
          <div className="bg-blue-50 p-4 rounded border border-blue-200">
            <div className="flex flex-col md:flex-row items-center">
              <div className="flex-shrink-0 mr-4">
                <h3 className="font-medium">CSV Data Source:</h3>
              </div>
              <div className="flex-grow">
                <input
                  type="file"
                  accept=".csv"
                  onChange={handleFileUpload}
                  className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
              </div>
            </div>
          </div>
          
          {/* Stats Summary */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="bg-white p-4 rounded shadow">
              <h3 className="text-sm font-medium text-gray-500">Total Jobs</h3>
              <p className="text-2xl font-bold">{stats.totalJobs?.toLocaleString() || 0}</p>
            </div>
            <div className="bg-white p-4 rounded shadow">
              <h3 className="text-sm font-medium text-gray-500">Success Rate</h3>
              <p className="text-2xl font-bold">
                {stats.totalJobs ? ((stats.successfulJobs / stats.totalJobs) * 100).toFixed(1) : 0}%
              </p>
            </div>
            <div className="bg-white p-4 rounded shadow">
              <h3 className="text-sm font-medium text-gray-500">Total Credits</h3>
              <p className="text-2xl font-bold">{stats.totalCredits?.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) || 0}</p>
            </div>
            <div className="bg-white p-4 rounded shadow">
              <h3 className="text-sm font-medium text-gray-500">Avg. Runtime (sec)</h3>
              <p className="text-2xl font-bold">{stats.averageJobRuntime?.toFixed(1) || 'N/A'}</p>
            </div>
          </div>
          
          {/* Active Filters Display */}
          {(Object.keys(activeFilters).length > 0 || activeDateRange.startDate || activeDateRange.endDate) && (
            <div className="bg-blue-50 p-4 rounded border border-blue-200">
              <div className="flex justify-between items-center mb-2">
                <h3 className="font-medium">Active Filters:</h3>
                <button 
                  className="text-sm text-red-600 hover:text-red-800"
                  onClick={resetFilters}
                >
                  Clear All Filters
                </button>
              </div>
              <div className="flex flex-wrap gap-2">
                {Object.entries(activeFilters).map(([field, values]) => 
                  values && values.length > 0 ? (
                    <div key={field} className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                      <span className="font-medium">{field}:</span> {Array.isArray(values) ? values.join(', ') : values}
                    </div>
                  ) : null
                )}
                
                {(activeDateRange.startDate || activeDateRange.endDate) && (
                  <div className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                    <span className="font-medium">JOB_RUN_STARTED_AT:</span> 
                    {activeDateRange.startDate && activeDateRange.endDate 
                      ? `${activeDateRange.startDate} to ${activeDateRange.endDate}`
                      : activeDateRange.startDate 
                        ? `From ${activeDateRange.startDate}` 
                        : `Until ${activeDateRange.endDate}`
                    }
                  </div>
                )}
              </div>
            </div>
          )}
          
          {/* Search and Controls */}
          <div className="flex flex-col md:flex-row gap-4 items-center">
            <div className="flex-1">
              <input
                type="text"
                placeholder="Search all columns..."
                className="w-full p-2 border rounded"
                value={searchTerm}
                onChange={(e) => {
                  setSearchTerm(e.target.value);
                  setCurrentPage(1);
                }}
              />
            </div>
            
            <div className="flex gap-2">
              <select 
                className="p-2 border rounded"
                value={rowsPerPage}
                onChange={(e) => {
                  setRowsPerPage(Number(e.target.value));
                  setCurrentPage(1);
                }}
              >
                <option value={10}>10 rows</option>
                <option value={20}>20 rows</option>
                <option value={50}>50 rows</option>
                <option value={100}>100 rows</option>
              </select>
              
              <div className="relative">
                <button 
                  className="p-2 border rounded bg-white"
                  onClick={() => document.getElementById('column-selector').classList.toggle('hidden')}
                >
                  Columns
                </button>
                <div 
                  id="column-selector" 
                  className="absolute right-0 mt-1 w-64 bg-white border rounded shadow-lg p-2 z-10 hidden max-h-96 overflow-y-auto"
                >
                  {data.length > 0 && Object.keys(data[0]).map(column => (
                    <div key={column} className="flex items-center p-1">
                      <input
                        type="checkbox"
                        id={`col-${column}`}
                        checked={visibleColumns.includes(column)}
                        onChange={() => toggleColumnVisibility(column)}
                        className="mr-2"
                      />
                      <label htmlFor={`col-${column}`} className="text-sm">{column}</label>
                    </div>
                  ))}
                </div>
              </div>
              
              <button 
                className="p-2 border rounded bg-blue-500 text-white"
                onClick={() => document.getElementById('filter-panel').classList.toggle('hidden')}
              >
                Filters
              </button>
            </div>
          </div>
          
          {/* Filter Panel */}
          <div id="filter-panel" className="bg-gray-100 p-4 rounded shadow hidden">
            {/* Date Range Filter for JOB_RUN_STARTED_AT */}
            <div className="border-b pb-4 mb-4">
              <h3 className="text-lg font-medium mb-2">Job Start Date Range</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">From Date</label>
                  <input 
                    type="date" 
                    className="w-full p-2 border rounded"
                    value={dateRange.startDate}
                    min={dateBoundaries.min}
                    max={dateRange.endDate || dateBoundaries.max}
                    onChange={(e) => setDateRange({...dateRange, startDate: e.target.value})}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">To Date</label>
                  <input 
                    type="date" 
                    className="w-full p-2 border rounded"
                    value={dateRange.endDate}
                    min={dateRange.startDate || dateBoundaries.min}
                    max={dateBoundaries.max}
                    onChange={(e) => setDateRange({...dateRange, endDate: e.target.value})}
                  />
                </div>
              </div>
            </div>
            
            {/* Column Filters */}
            <h3 className="text-lg font-medium mb-2">Column Filters</h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              {Object.keys(columnOptions)
                .filter(column => ['ORGANIZATION_NAME', 'PROJECT_NAME', 'VCS_NAME', 'VCS_BRANCH', 'JOB_BUILD_STATUS', 'OPERATING_SYSTEM', 'EXECUTOR'].includes(column))
                .map(column => (
                  <div key={column} className="flex flex-col">
                    <label className="text-sm font-medium mb-1">{column}</label>
                    <select
                      className="w-full p-2 border rounded"
                      value={filters[column] || ''}
                      onChange={(e) => handleFilterChange(column, e.target.value ? [e.target.value] : [])}
                    >
                      <option value="">All</option>
                      {columnOptions[column].map(option => (
                        <option key={option} value={option}>
                          {option || 'NULL'}
                        </option>
                      ))}
                    </select>
                  </div>
                ))
              }
            </div>
            <div className="flex justify-end gap-2">
              <button 
                className="p-2 border rounded bg-gray-300"
                onClick={resetFilters}
              >
                Reset
              </button>
              <button 
                className="p-2 border rounded bg-blue-500 text-white"
                onClick={applyFilters}
              >
                Apply Filters
              </button>
            </div>
          </div>
          
          {/* Data Table */}
          <div className="overflow-x-auto border rounded shadow">
            <table className="min-w-full bg-white">
              <thead className="bg-gray-100">
                <tr>
                  {visibleColumns.map(column => (
                    <th 
                      key={column}
                      className="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
                      onClick={() => requestSort(column)}
                    >
                      {column}
                      {sortConfig.key === column && (
                        <span className="ml-1">
                          {sortConfig.direction === 'asc' ? '▲' : '▼'}
                        </span>
                      )}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {paginatedData.length > 0 ? (
                  paginatedData.map((row, rowIndex) => (
                    <tr key={rowIndex} className="hover:bg-gray-50">
                      {visibleColumns.map(column => (
                        <td key={column} className="py-2 px-4 text-sm">
                          {formatValue(row[column], column)}
                        </td>
                      ))}
                    </tr>
                  ))
                ) : (
                  <tr>
                    <td 
                      colSpan={visibleColumns.length} 
                      className="py-4 px-4 text-center text-gray-500"
                    >
                      No data found matching your criteria
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
          
          {/* Pagination */}
          <div className="flex justify-between items-center">
            <div className="text-sm text-gray-500">
              Showing {paginatedData.length > 0 ? (currentPage - 1) * rowsPerPage + 1 : 0} to {Math.min(currentPage * rowsPerPage, sortedData.length)} of {sortedData.length} results
            </div>
            <div className="flex space-x-1">
              <button
                className="px-3 py-1 border rounded bg-white disabled:opacity-50"
                disabled={currentPage === 1}
                onClick={() => setCurrentPage(1)}
              >
                &laquo;
              </button>
              <button
                className="px-3 py-1 border rounded bg-white disabled:opacity-50"
                disabled={currentPage === 1}
                onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
              >
                &lsaquo;
              </button>
              
              <span className="px-3 py-1 border rounded bg-gray-100">
                {currentPage} / {totalPages || 1}
              </span>
              
              <button
                className="px-3 py-1 border rounded bg-white disabled:opacity-50"
                disabled={currentPage === totalPages || totalPages === 0}
                onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
              >
                &rsaquo;
              </button>
              <button
                className="px-3 py-1 border rounded bg-white disabled:opacity-50"
                disabled={currentPage === totalPages || totalPages === 0}
                onClick={() => setCurrentPage(totalPages)}
              >
                &raquo;
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Render the app
    ReactDOM.render(<CircleCIDataDashboard />, document.getElementById('app'));
  </script>
</body>
</html>
