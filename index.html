<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple CircleCI Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">CircleCI Build Data Dashboard</h1>
    
    <!-- File Upload -->
    <div class="bg-white p-4 rounded shadow mb-6">
      <h2 class="text-lg font-medium mb-2">Upload CSV Data</h2>
      <input type="file" id="csvFile" accept=".csv" class="block w-full mb-2">
      <div id="uploadStatus" class="text-sm text-gray-600"></div>
    </div>
    
    <!-- Filters -->
    <div class="bg-white p-4 rounded shadow mb-6" id="filterSection" style="display: none;">
      <h2 class="text-lg font-medium mb-2">Filters</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="filterControls"></div>
      <div class="mt-4 flex justify-end space-x-2">
        <button id="resetFilterBtn" class="px-3 py-1 bg-gray-200 rounded">Reset</button>
        <button id="applyFilterBtn" class="px-3 py-1 bg-blue-500 text-white rounded">Apply Filters</button>
      </div>
    </div>
    
    <!-- Table -->
    <div class="bg-white rounded shadow overflow-hidden" id="tableContainer" style="display: none;">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="dataTable">
          <thead class="bg-gray-50">
            <tr id="tableHeader"></tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="tableBody"></tbody>
        </table>
      </div>
      <div class="p-2 flex justify-between items-center bg-gray-50">
        <div id="pagination" class="text-sm text-gray-600"></div>
        <div class="flex space-x-2">
          <button id="prevPage" class="px-2 py-1 bg-gray-200 rounded disabled:opacity-50" disabled>Previous</button>
          <span id="pageInfo" class="px-2 py-1">Page 1</span>
          <button id="nextPage" class="px-2 py-1 bg-gray-200 rounded disabled:opacity-50" disabled>Next</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State variables
    let data = [];
    let filteredData = [];
    let columns = [];
    let currentPage = 1;
    let rowsPerPage = 20;
    let filters = {};
    
    // Common columns to show as filters by default
    const defaultFilterColumns = [
      'ORGANIZATION_NAME', 'PROJECT_NAME', 'VCS_NAME', 'VCS_BRANCH', 
      'JOB_NAME', 'JOB_BUILD_STATUS', 'OPERATING_SYSTEM', 'EXECUTOR'
    ];
    
    // All possible columns for filtering
    const allFilterColumns = [
      'ORGANIZATION_ID', 'ORGANIZATION_NAME', 'ORGANIZATION_CREATED_DATE',
      'PROJECT_ID', 'PROJECT_NAME', 'PROJECT_CREATED_DATE',
      'LAST_BUILD_FINISHED_AT',
      'VCS_NAME', 'VCS_URL', 'VCS_BRANCH',
      'PIPELINE_ID', 'PIPELINE_CREATED_AT', 'PIPELINE_NUMBER', 'IS_UNREGISTERED_USER', 'PIPELINE_TRIGGER_SOURCE', 'PIPELINE_TRIGGER_USER_ID',
      'WORKFLOW_ID', 'WORKFLOW_NAME', 'WORKFLOW_FIRST_JOB_QUEUED_AT', 'WORKFLOW_FIRST_JOB_STARTED_AT', 'WORKFLOW_STOPPED_AT', 'IS_WORKFLOW_SUCCESSFUL',
      'JOB_NAME', 'JOB_RUN_NUMBER', 'JOB_ID', 'JOB_RUN_DATE', 'JOB_RUN_QUEUED_AT', 'JOB_RUN_STARTED_AT', 'JOB_RUN_STOPPED_AT', 'JOB_BUILD_STATUS',
      'RESOURCE_CLASS', 'OPERATING_SYSTEM', 'EXECUTOR', 'PARALLELISM',
      'JOB_RUN_SECONDS', 'MEDIAN_CPU_UTILIZATION_PCT', 'MAX_CPU_UTILIZATION_PCT', 'MEDIAN_RAM_UTILIZATION_PCT', 'MAX_RAM_UTILIZATION_PCT',
      'COMPUTE_CREDITS', 'DLC_CREDITS', 'USER_CREDITS', 'STORAGE_CREDITS', 'NETWORK_CREDITS', 'LEASE_CREDITS', 'LEASE_OVERAGE_CREDITS', 'IPRANGES_CREDITS', 'TOTAL_CREDITS'
    ];
    
    // References to DOM elements
    const csvFileInput = document.getElementById('csvFile');
    const uploadStatus = document.getElementById('uploadStatus');
    const filterSection = document.getElementById('filterSection');
    const filterControls = document.getElementById('filterControls');
    const tableContainer = document.getElementById('tableContainer');
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    const resetFilterBtn = document.getElementById('resetFilterBtn');
    const applyFilterBtn = document.getElementById('applyFilterBtn');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    const pagination = document.getElementById('pagination');
    
    // Handle file upload
    csvFileInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      uploadStatus.textContent = 'Reading file...';
      
      Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(results) {
          // Store data and columns
          data = results.data;
          columns = results.meta.fields;
          
          // Start with all data
          filteredData = [...data];
          currentPage = 1;
          
          // Show success message
          uploadStatus.textContent = `Successfully loaded ${data.length} rows of data.`;
          
          // Setup filters
          setupFilters();
          
          // Render table
          renderTable();
          
          // Show filter and table sections
          filterSection.style.display = 'block';
          tableContainer.style.display = 'block';
        },
        error: function(error) {
          uploadStatus.textContent = `Error parsing CSV: ${error.message}`;
        }
      });
    });
    
    // Set up filter controls
    function setupFilters() {
      // Clear existing filters
      filterControls.innerHTML = '';
      filters = {};
      
      // Get available columns
      const availableColumns = columns.filter(column => 
        allFilterColumns.includes(column)
      );
      
      // Create filter for each column
      availableColumns.forEach(column => {
        // Get unique values for this column
        const uniqueValues = [...new Set(data.map(item => item[column]))].filter(Boolean);
        
        // Create filter control div
        const filterControl = document.createElement('div');
        filterControl.className = 'mb-2';
        
        // Create label
        const label = document.createElement('label');
        label.className = 'block text-sm font-medium text-gray-700 mb-1';
        label.textContent = column;
        
        // Create select element
        const select = document.createElement('select');
        select.className = 'block w-full p-2 border rounded text-sm';
        select.id = `filter-${column}`;
        
        // Add default "All" option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'All';
        select.appendChild(defaultOption);
        
        // Add options for unique values (limit to 100 options for performance)
        uniqueValues.slice(0, 100).sort().forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = String(value).substring(0, 50); // Truncate long values
          select.appendChild(option);
        });
        
        // Add event listener
        select.addEventListener('change', function() {
          filters[column] = this.value;
        });
        
        // Append elements
        filterControl.appendChild(label);
        filterControl.appendChild(select);
        filterControls.appendChild(filterControl);
      });
    }
    
    // Apply filters to data
    function applyFilters() {
      filteredData = data.filter(row => {
        // Check each filter
        for (const [column, value] of Object.entries(filters)) {
          if (value && row[column] != value) {
            return false;
          }
        }
        return true;
      });
      
      // Reset to first page
      currentPage = 1;
      
      // Update table
      renderTable();
    }
    
    // Reset filters
    function resetFilters() {
      // Reset filter controls
      const filterSelects = filterControls.querySelectorAll('select');
      filterSelects.forEach(select => {
        select.value = '';
      });
      
      // Clear filter values
      filters = {};
      
      // Reset to all data
      filteredData = [...data];
      currentPage = 1;
      
      // Update table
      renderTable();
    }
    
    // Render table with current data
    function renderTable() {
      // Clear existing table
      tableHeader.innerHTML = '';
      tableBody.innerHTML = '';
      
      // Add table headers
      columns.forEach(column => {
        const th = document.createElement('th');
        th.className = 'px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = column;
        tableHeader.appendChild(th);
      });
      
      // Calculate pagination
      const totalPages = Math.ceil(filteredData.length / rowsPerPage);
      const startIndex = (currentPage - 1) * rowsPerPage;
      const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
      const currentRows = filteredData.slice(startIndex, endIndex);
      
      // Add table rows
      currentRows.forEach(row => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        
        columns.forEach(column => {
          const td = document.createElement('td');
          td.className = 'px-3 py-2 text-sm text-gray-500';
          
          // Format special values
          const value = row[column];
          if (value === null || value === undefined || value === "\\N") {
            td.textContent = "â€”";
          } else if (typeof value === 'boolean') {
            td.textContent = value ? 'Yes' : 'No';
          } else if (column.includes('CREDITS') && typeof value === 'number') {
            td.textContent = value.toFixed(2);
          } else {
            td.textContent = String(value);
          }
          
          tr.appendChild(td);
        });
        
        tableBody.appendChild(tr);
      });
      
      // Update pagination info
      pagination.textContent = `Showing ${startIndex + 1} to ${endIndex} of ${filteredData.length} results`;
      pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
      
      // Update pagination buttons
      prevPageBtn.disabled = currentPage === 1;
      nextPageBtn.disabled = currentPage >= totalPages;
    }
    
    // Event listeners for filter buttons
    resetFilterBtn.addEventListener('click', resetFilters);
    applyFilterBtn.addEventListener('click', applyFilters);
    
    // Event listeners for pagination
    prevPageBtn.addEventListener('click', function() {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    });
    
    nextPageBtn.addEventListener('click', function() {
      const totalPages = Math.ceil(filteredData.length / rowsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderTable();
      }
    });
  </script>
</body>
</html>
